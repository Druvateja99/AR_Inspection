// Assets/Scripts/RuntimeGltfLoader.cs
using UnityEngine;
using System.Threading.Tasks;
using GLTFast;
using GLTFast.Logging;

public class RuntimeGltfLoader : MonoBehaviour
{
    /// <summary>
    /// Loads a GLTF/GLB from a local sandbox path and parents it under 'parent'.
    /// </summary>
    public async Task<GameObject> LoadGltf(string localPath, Transform parent)
    {
        // Prefix with file:// for local file URI
        var uri = localPath.StartsWith("file://") ? localPath : "file://" + localPath;
        Debug.Log($"[GLTFast] Load request: {uri}");

        var gltf = new GltfImport(logger: new ConsoleLogger());

        var loadOk = await gltf.Load(uri);
        if (!loadOk)
        {
            Debug.LogError($"[GLTFast] Load() returned false. Path: {localPath}");
            return null;
        }

        var root = new GameObject("CAD_Runtime");
        var instOk = await gltf.InstantiateMainSceneAsync(root.transform);
        if (!instOk)
        {
            Debug.LogError("[GLTFast] InstantiateMainSceneAsync() returned false");
            Object.Destroy(root);
            return null;
        }

        if (parent != null)
            root.transform.SetParent(parent, false);

        Debug.Log("[GLTFast] Model instantiated successfully.");
        return root;
    }
}
