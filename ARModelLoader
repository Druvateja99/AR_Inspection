
// Assets/Scripts/AR/ARModelLoader.cs
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.EventSystems;
using UnityEngine.XR.ARFoundation;
using UnityEngine.XR.ARSubsystems;
using Unity.XR.CoreUtils;

public class ARModelLoader : MonoBehaviour
{
    [Header("AR Managers (assign from scene)")]
    public XROrigin xrOrigin;
    public ARRaycastManager raycastManager;
    public ARPlaneManager planeManager;        // optional (for visualizing planes)
    public ARCameraManager arCameraManager;    // optional (camera control)

    [Header("Model Loading")]
    public Transform modelParent;              // e.g., XROrigin.transform; where model will attach
    public Material transparentMaterial;       // set Rendering Mode=Transparent, alpha ~0.3â€“0.6
    public GameObject currentModel;            // the loaded instance (runtime)

    [Header("Placement & Alignment")]
    public bool tapToPlaceEnabled = true;
    public float rotateSpeed = 40f;            // degrees/sec
    public float scaleStep = 0.02f;            // per tap

    // Internal
    private static readonly List<ARRaycastHit> s_Hits = new List<ARRaycastHit>();
    private Camera arCamera;

    void Awake()
    {
        // Use new APIs to find managers
        if (xrOrigin == null)       xrOrigin       = Object.FindFirstObjectByType<XROrigin>();
        if (raycastManager == null) raycastManager = Object.FindAnyObjectByType<ARRaycastManager>();
        if (planeManager == null)   planeManager   = Object.FindAnyObjectByType<ARPlaneManager>();
        if (arCameraManager == null) arCameraManager = Object.FindAnyObjectByType<ARCameraManager>();

        // Prefer XR Origin camera
        arCamera = xrOrigin != null ? xrOrigin.Camera : Camera.main;

        // Default parent to XR Origin
        if (modelParent == null && xrOrigin != null) modelParent = xrOrigin.transform;

        // Optional helpful logs
        if (xrOrigin == null)       Debug.LogError("[ARModelLoader] Missing XROrigin in scene.");
        if (raycastManager == null) Debug.LogWarning("[ARModelLoader] Missing ARRaycastManager (tap-to-place disabled).");
        if (arCameraManager == null) Debug.LogWarning("[ARModelLoader] Missing ARCameraManager.");
    }

    void Update()
    {
        if (currentModel == null) return;

        // Tap-to-place on planes
        if (tapToPlaceEnabled && Input.touchCount > 0)
        {
            var touch = Input.GetTouch(0);
            if (touch.phase == TouchPhase.Began && !IsPointerOverUI(touch.position))
            {
                TryPlaceAt(touch.position);
            }
        }

#if UNITY_EDITOR
        // Simple dev keyboard rotate
        if (Input.GetKey(KeyCode.Q)) currentModel.transform.Rotate(Vector3.up, -rotateSpeed * Time.deltaTime, Space.World);
        if (Input.GetKey(KeyCode.E)) currentModel.transform.Rotate(Vector3.up,  rotateSpeed * Time.deltaTime, Space.World);
#endif
    }

    /// <summary>
    /// Called by your Align flow when a GLTF/GLB has been instantiated.
    /// </summary>
    public void SetCurrentModel(GameObject go)
    {
        if (go == null) { Debug.LogError("[ARModelLoader] SetCurrentModel received null."); return; }

        // Destroy previous
        if (currentModel != null) Destroy(currentModel);

        currentModel = go;

        // Parent & reset
        if (modelParent != null && go.transform.parent != modelParent)
            go.transform.SetParent(modelParent, false);

        go.transform.localPosition = Vector3.zero;
        go.transform.localRotation = Quaternion.identity;
        go.transform.localScale    = Vector3.one;

        // Apply transparent material
        ApplyTransparentMaterial(currentModel);

        Debug.Log("[ARModelLoader] Model assigned and ready for placement.");
    }

    /// <summary>
    /// If you load prefabs from Resources.
    /// </summary>
    public void LoadFromResources(string resourcesPath)
    {
        var prefab = Resources.Load<GameObject>(resourcesPath);
        if (prefab == null)
        {
            Debug.LogError($"Resources.Load failed: {resourcesPath}");
            return;
        }
        // Instantiate a prefab and set as current
        var go = Instantiate(prefab, modelParent);
        SetCurrentModel(go);
    }

    /// <summary>
    /// Tap-to-place using ARRaycastManager.
    /// </summary>
    public void TryPlaceAt(Vector2 screenPos)
    {
        if (raycastManager == null || arCamera == null) return;
        s_Hits.Clear();

        if (raycastManager.Raycast(screenPos, s_Hits, TrackableType.PlaneWithinPolygon))
        {
            var hitPose = s_Hits[0].pose;
            currentModel.transform.position = hitPose.position;
            currentModel.transform.rotation = hitPose.rotation;
        }
    }

    // UI hooks for rotate/scale
    public void RotateLeft()  { if (currentModel) currentModel.transform.Rotate(Vector3.up, -rotateSpeed * Time.deltaTime * 10f, Space.World); }
    public void RotateRight() { if (currentModel) currentModel.transform.Rotate(Vector3.up,  rotateSpeed * Time.deltaTime * 10f, Space.World); }
    public void ScaleUp()     { if (currentModel) currentModel.transform.localScale += Vector3.one * scaleStep; }
    public void ScaleDown()   { if (currentModel) currentModel.transform.localScale  = Vector3.Max(currentModel.transform.localScale - Vector3.one * scaleStep, Vector3.one * 0.01f); }

    private bool IsPointerOverUI(Vector2 screenPos)
    {
        if (EventSystem.current == null) return false;
        var ed = new PointerEventData(EventSystem.current) { position = screenPos };
        var results = new List<RaycastResult>();
        EventSystem.current.RaycastAll(ed, results);
        return results.Count > 0;
    }

    private void ApplyTransparentMaterial(GameObject go)
    {
        if (transparentMaterial == null)
        {
            Debug.LogWarning("[ARModelLoader] Transparent material not assigned.");
            return;
        }

        var renderers = go.GetComponentsInChildren<Renderer>(true);
        foreach (var r in renderers)
        {
            var mats = r.sharedMaterials;
            for (int i = 0; i < mats.Length; i++)
            {
                mats[i] = new Material(transparentMaterial); // clone
            }
            r.sharedMaterials = mats;
        }
    }
}
